### short [01-apigw-v2]

- complete Stage 
- add Stage ref to ApiMapping
- replace \\$default ref with ${AppStage}

- add CORS credentials as True
- check if cloudformation supports list parameters
- pass EndpointUrls parameter for use with allowed CORS origins
- lambdas to round- trip supplied host name as permitted origin

- domain scripts
- remove us-east-1 from domain scripts
- create eu-west-1 certificate for spaas.link

- POST body may need to be base64.b63decode'd [isBase64Encoded parameter]
- add special 400 clause to lambda bodies for CORS error testing

### website

- top level api
- proxy route and integration
- redirect route and integration
- binary media types handling
- replace _ns refs with _namespace
- replace parent/child_namespace with (eg) api/endpoint_namespace

### medium

- lambda alarms 
- event timer
- layer builder
- secrets

- binding script
- migration script
- user scripts

- react website demo

### long

- cross- account deployments
- step functions
- federated auth
- passwordless auth
- s3 multipart uploads
- tracing and xrays
- appsync
- rockset

### thoughts

- refactor policy_permissions helper?
  - not clear how
- eliminate unnecessary classes in web_xxx.py demos?
  - not convinced
- move cognito subclasses into web_api subdirs?
  - it's just not clear where this crap should live
- topic worker?
  - think it's an anti- pattern
- rename single streaming table?
- refactor "worker" name passed to event_worker?
- investigate if default resource_name should actually be base_resource_name?
- extend IAM role for args required by IdentityPoolRole?
  - not sure is possible as policies are too different
- does dehungarorise() need to take into account initials and numbers?
  - have to see
- permissions, size/timeout tests?
  - not sure it adds anything
- nest tests?
  - think it obfuscates stuff
- remove yaml dependency?
  - no; too much yaml everywhere
- fold website into bucket?
- refactor action -function as -action (?)
- apigw logging?
  - not clear you need it as alex de brie says is very verbose
  - and once you have the apigw patterns down, it's probably superfluous
- separate api cognito package?
  - doesn't make any sense
- userpool should be named private-api?
  - can't think why I wanted to do this
- make database and bucket fixed assets, like errors?
- seems inconsistent that table has an appname prefix but api does not
- push_artifacts.py didn't seem to throw exception on bad POST schema in infa
  - problem is that endpoint schema is only required to be an object with no validation
- why do I get occasional permissions problems because schema seems to allow (incorrect) attributes at root level ?
  - unclear :(
- check for duplicate event names ?
  - probably not much necessary
- check for empty model schema ?
  - not worth it
- GET endpoint should allow blank parameters ?
  - better to be explicit
- add handler for blank infra (or exception) ?
  - not sure
- validate schema format ?
  - leave as free- form
- infer GET/POST from parameters/schema?
  - no is probably clearer not to
- apply table defaults at root table level?
  - no because is more complex, applied at nested level
- consider refactoring event topic, pattern as head, body?
  - think topic, pattern probably more naturalg

### done

- test removal of Route alt namespacing
- merge user pool clients into single resource with all existing auth flows
- change prefixes of DomainName attributes used by RecordSet from "Distributed" to "Regional"
- Route target is badly specified with /aws/lambda prefix, should be integrations
- remove RequestParameters from Route
- remove AutoDeploy from api
- remove GatewayResponse classes
- clean up stacks
- remove woldeploy-us-east-1

```
However, when AllowCredentials is true, AllowOrigins cannot be '*'; it must specify actual origins rather than a wildcard for browsers to respect the AllowCredentials setting.
```

- IdentityPool AllowUnauthenticatedIdentities false
- show template to chatgpt
- refactor parent_ns as namespace, child_ns as child_namespace/endpoint_namespace
- ensure recipes always pass named arguments
- assert cors understanding with chatgpt
- add cors support to top level api
- Domain Name is changed
- Api "ProtocolType" "HTTP"
- check whether Name fields are really quired
- remove deployment
- check auto deployment
- check authorizer getting user pool client name
- implement routes and integrations at web_api recipe layer
- bad user_pool_ref
- complete authorizer implementation
- assert understanding of parameter validation with chatgpt
- route parameter validation
- only two routes being created
- only one integration being created
- route target
- remove / in endpoint namespace
- route route key
- add method to demos
- public/private route subclassing
- complete integration implementation
- skeleton routines to add route and integration for each endpoint
- check authorizer implementation
- rename hello examples as public/private
- add private POST example
- filter auth parameters and only add private stuff if you have a private method
- add back deployment method filtering by iterating over methods
- bad ref to AppRestApi
- check web app pattern runs
- consider sns-to-slack pattern
- add back 1.0 interval to streaming-table
- redefine web-api demo to remove auth
- refactor web-api to use single private example
- remove existing validation code
- remove existing auth code
- remove existing cors code
- check gateway responses
- check validation
- replace method base class with route and integration
- replace BasePathMapping with ApiMapping
- remove restapi binary media types
- replace restapi and associated refs with api
- remove resources
- add apigatewayv2 irregular
- rename apigateway as apigatewayv2
- script to filter lambda logs
- add error logging to task queue
- add error logging to streaming table 
- logging to check for existence of subscription filters before adding
- logging to be implemented in Recipe subclass SlackLoggingRecipe

- sqs irregular
- complete gist tests

- [web-site] either binary media types or root redirect
- [web-site] binary media types must be an array
- [streaming-table] add eventName INSERT to sample pattern
- revert to empty default iam permissions
- [event-worker] demo event to be hello world

- rename lambda_module
- rename ingredients as services
- move events permission into event worker
- add sub directories to web_api recipe
- move apigw subclasses inline and refactor
- move lambda subclasses inline and refactor
- review generated roles and policies for bad stuff
- every recipe which creates role to also create a policy
- run demos
- separate role and permission
- separate policy from role for all ingredients

- gist
- demo
- recipe
- sqs resources
- inline code
- lambda extensions

- DynamoDB not Dynamodb
  - likely requires irregular
- streaming role needs table stream arn not table arn

```
"Resource": {
	"Fn::GetAtt": ["AppTable", "StreamArn"]
}
```

- table not visible
- change demo detail to use {pk: [{prefix: LEAGUE}]}
- simplify recipe workflow to include init_streaming
- used recipe naming in other demos
- check table ref is in a list
- table role permissions should include table reference
- hardcode table ref in worker event pattern
- modify demo pattern detail
- add worker to streaming table demo
- script to use TABLE_NAME rather than function context as source
- add notes relating to structure of message; also that Detail, DetailType and Source are required by Eventbridge
- pass TABLE_NAME as lambda environment variable
- Permission shouldn't need function_namespace arg as should be created in same namespace
- non- table resources should be created in child namespace
- event source mapping to be passed function namespace equal to child namespace
- event source mapping
- function
- role
- table
- recipe skeleton
- GSI support
- what does table streaming function do for DetailType and Source?
- ddb lookback permissions
- table event source mapping
- consistent approach to use of **kwargs
- all super() calls to specify args
- event source mapping
- lambda/table
- check template will pick up mis- specified inline function refs from logs
- event-worker demo requires detail as part of pattern
- logs aws/lambda/${{FunctionName}} not /aws/lambda/{FunctionName}
- apigw default binary media types is none
- logs.amazonaws.com not logs.amazon.com
- review event worker template
- event_worker rule permission
- events rule permission class
- add sample event list to event_worker demo
- event_worker recipe to bind list of events to function
- event permission class
 
- event class
  - namespace
    - child of function_namespace
	- see apis and endpoints
  - pattern
  - target
    - function binding

- common Recipe  function and permissions helpers
- subscription filter namespacing is incorrect
- event worker subscription filters
- subscription filter depends
- how do log group and log stream know their functions?
- event worker log group and log stream
- event worker role
- event worker function
- event worker event invocation config
- lambda event invocation config
- subscription filter filter pattern and destination arn
- check log group classes
- pass webhook url as env variable into slack function
- pass logging level as env variable into slack function
- per- level slack logs function
- slack webhook logs permission
- add slack webhook role
- add role and permission to event_worker demo
- move slack function into slack subdir with inline_code.py
- check event_worker demo still works
- move cors into apigw subdir
- consider removing Proxy in names
- move redirect method to s3 and rename
- add identity pool condition helper
- allow subclassing of roles and permissions in ingredients packages

- move cognito role crap
- logs subscription filter
- error, warning subscription filters
- logs group, logs stream
- slack webhook function
- change lambda to a directory to allow room for inline code
- rename webapi, website

- POST model not being called
  - https://stackoverflow.com/questions/78165982/apigateway-http-post-request-body-validation-model-apparently-not-being-called
  - https://support.console.aws.amazon.com/support/home?region=eu-west-1#/case/?displayId=171049629001925&language=en

- ProviderARNs not ProviderARNS
- cognito auth value is COGNITO_USER_POOLS
- apigw cognito auth should use AuthorizationType property not Authorization
- method AuthorizerId not Authorizer
- webapp lambda proxy permission needs to be on a per- endpoint basis!
- IAM role policy name needs to be in Fn::Sub
- ensure website can override index.html root path
- remove StageName from Deployment
- AWS::ApiGateway::DomainName does not have RestApiId
- Model needs a name and must be alphanumeric, so hungarorise resource name is best
- rename services as ingredients
- permissions helper to handle wildcards overriding defaults
- webapi support for S3 functions and paths
- deployment should include stage
- move website permission generation inline
- inline generation of identity pool roles
- family pack mixin
- remove echo function namespace references
- inline and s3 lambdas
- real handler code
- move code inline in demo
- function_kwargs(endpoint) helper
- replace default permissions with helper which extends permissions
- extend RoleBase with Role
- Role to generate permissions
- webapi roles
- webapi functions 
- layers
- environment
- code
- role
- check spacing around equals
- identity pool roles
- remove IdentityPool permissions
- replace tuple- based permissions format with dict
- formatters to format statement
- undo s3 policy document overriding
- new permissions support
  - either a list of permissions strings
    - group together with wildcard resource
  - or a list of (permissions, resource) tuples
- remove permission grouping
- website role
- deployment
- replace ${name} with inline lookup for DomainName
- root redirect
- fix {name} in root redirect
- bucket
- method
- website component
- website demo
- modify index.html to be default arg in redirect method
- website resource (proxy)
- apigw root redirect method
- apigw website method
- bucket
- apigw restapi optional BinaryMediaTypes
- rename web_api as webapi
- proper schema for hello-post
- add identity pool mapping to component
- permission source arn is messed up

```
  source_arn = {"Fn::Sub": "arn:aws:execute-api:${{AWS::Region}}:${{AWS::AccountId}}:${%s}/${%s}/%s/%s" % (restapiref, stageref, method, path)}
```

- add identity pool to component
- hardcode identity pool client id as user pool web client
- double curly brackets around AWS::Stack
- check template generation
- remove pool type field
- override simple email resource type field to reflect base class

- add notes saying why this is being done
  - when you subclass a resource and need to reference it from other resources in the same module, it's simplest to override the resource type parameter so it refers to the base class
   - where the subclass is not referenced by other resources in the module, but is referenced at the component level, eh endpoint stuff and gateway responses, it's more convenient to have the full class name as part of the type 

- identity pool roles
- single web_api component
- private switch
- validator reference is not including api_namespace
- confusion between CORS and Cors
- template inline refs
- template parameter insertion
- template ref lookup
- output visible resources
- resource visibility decorator
- revert component to list
- add notes that component is just a list of resources
- component to render to template
- override template.resources.append
- replace component with template
- consider overriding template.resources.append
- permissions grouping
- yaml config
- role
- CORS is not being lowercased when hungarorised as part of logical id
- check use of AWS::Stack
- check where comments include "required?"
- apigw deployment must depend on all endpoints
- check refs to rest-api in endpoint- related classes
  - requires api_namespace
- Permission needs api namespace to generate source arn
- permission resource
- authorizer resource
- api permission source arn is messed up
- api proxy method to reference -function suffix (given namespace)
- rename name as namespace
- hungarorise should lowercase then capitalise
- POST model
- endpoint to use explicit parent/child naming convention
- CorsMethod
- Validator
- replace private parameter with class implementations
- separate public, private api classes
- add separate method / subclass for endpoint initialisation
- LambdaProxyMethod authorisation
- domain stuff
- replace base class constructors with super()
- GatewayResponse ResponseParameters
- endpoints list
- check refs to AWS::StackName
- add back Fn::Sub expression for RestApi Name, without using f() 
- restapi Fn::Sub/Name expressions looks messed up
- aws resource type case sensitivity -> "Restapi"
- component resource keys are messed up -> "whatevs-rest-api-'->"\"
- component base class
- resource rendering 
- remaining cognito role crap
- migrate components/api method
- corsmethod into aws/apigateway
- AWS::Cognito::*
- migrate components/api cognito stuff into aws/cognito
- resource_name to reflect latest class
- timers
- action events
- move aws directories
- resource naming to handle irregulars (apigateway)
- Resource base class resource_name, aws_type properties (based on class)
- lambda self.action, self.function
- "Ref"
- dehungarorise
- -domain (-domain-name)
- rest_api_id
- route53 record set should get distribution parameters from elsewhere, not from self?
- replace resource_suffix
- harmonise use of name paramters at aws level
- api method
- refactor pareto refs as pareto2
- remove component sub- directories
- load inline code
- SlackFunctionCode
- DDBStreaming Code
- logs
- functions
- permissions
- maintain a list of migrated components
- iam 
- add role base import statements 
- import rolebase 
- rename functionbase as rolebase
- rename function base as role base
- check all IAM components migrated
- move table IAM into streaming subdir 
- move API IAM into cognito subdir
- maintain same component module structure as of old

- layers
- indexes
- timer
- queue
- topic
- table events
- website events
- bucket events
- api POST
- test.py to auto- detect tests
- clean up apigw outputs
- add api hook to generate user outputs and resources
- expunge user/users from dsl
- refactor refs to api["user"]
- refactor refs to -user-userpool
- move user into api/ 
- refactor user keyword as api
- harmonised userpool/identitypool nomenclature

```
- No hosted zones named layers.spaas.link. found
```

- removedomain prefix
- add extensions list to dsl.expand (default [])
- remove enum from action event types
- modularise action events
- see if importlib.import_module uses a cache
- move load_files
- add extension directory to module sources
- lookup component modules dynamically
- make dsl.formatted generic
- move expander differ formatting code into dsl
- move differ stuff into dsl
- add check for multiple tables, buckets, websites, apis
- add check for bucket and website
- move dsl/components and parameters
- how to replace the setting of builder project name in the event rule for notifications?
- remove builder once layman2 retired
- document layer naming strategy for expander
- separate scripts from script
- fix api stagename as prod
- check how template hungarorises layer names
- eventbridge target id must be capped at length 64
- clean up setup.py
- abstract jsonschema to files
- rename config as dsl
- remove apigw randomised description
- remove apigw restapi/deployment/stage outputs
- remove all unnecessary scripts
- apigw auto deployment trick
- add timeouts to warning subscriptions
- apigw root redirect 
- events test to validate detail is dict
- moto lambda doesn't seem to exist 
- remove dashboards
- simplify push_artifacts handling of os variables so you don't need to maintain a manual list
- refactor api domain name as (eg) public-api
- refactor website domain name
- add website demo
- add website as event source
- add website event
- add website hooks similar to bucket hooks
- 404 support
- domain name
- role
- complete method
- rationalise component lookup code
- extend range of tests
- remove cors stuff from public api
- abstract api code like action
- add script helper which assures bucket avialable if builder declared
- rename project-builder as simply builder
- builder should reference core app bucket not custom bucket
- remove custom builder bucket
- replace action- related builder config with global table/bucket style
- expand events demos
- new action builder event rule
- replace builder bucket user directive
- add custom bucket back to builder
- add builder to schema event options
- remove builder from binding restrictions
- remove builder bindings from schema
- replace custom ddb/eventbridge streaming code with eventbridge pipes
- builder needs to be created with bucket reference
- ensure framework creates both warn and error logs stuff, with levels for each
- check refs created by init_logs_subscription
  - name needs to include both action and level
- replace refs to error with refs to logs with name and level
- replace ref to error-logs with simply logs
- pass level into logs as env variable
- rename error as logs
- MemorySizeSmall has no default value; SlackWebhookUrl has no default value; TimeoutShort has no default value
- allow WEBHOOK_URL as env variable
- dlqs to capture error- generating requests
- add api["name"] to domain prefixes
- check to ensure only only api can be created per app
  - or different apis with different prefixes?
- ensure push_artifacts looks us DOMAIN_XXX, CERTIFICATE_ARN
  - should probably expose all os variables to the build
- check outputs configuration
- complete components
- add components into apigw resource configuration
- ability to validate publishing of sns message
- poll for issued status
- delete_certificate fails to remove record set (missing TTL?)
- delete_record_set.py fails
- add print statements to create_certificate
- delete stray CNAME
- try creating CNAME with name provided from
- create_certificate.py to create cname record
- check certificate status 
- create_certificate.py to print record set details
- list_certificate to show status
- add scripts from polyreader2-server
- simplify errors function/role code
- check custom resource depends
- new custom resource
- new logstream function and role
- add slack- prefix to existing errors function
- logs event needs unpacking
- log subscriptions to depend on error permission
- push_artifacts to insert slack_error_webhook
- test by pinging polyreader /show-assets with invalid chunk index
- check that errors function, role, permission exist and are correct
- scripts to add dsl config errors entry
- generate template
- check that each action has a logs subscription
- errors to be loaded by config initialisation
- slack error webhook env variable
- check fn::sub will insert default second arg {}
- error filter pattern
- log subscriptions
- log permission
- per-  action susbscription and permissions 
- function size and timeout (small, short)
- slack handling inline code
- inline function and role singletons borrowed from table
- new errors component
- :64 length check for event rule names
- include ext/test/sqs
- create tagged version

- compare output with amplify flutter issue
  - https://github.com/aws-amplify/amplify-flutter/issues/431

- compare output with gist
  - https://gist.github.com/singledigit/2c4d7232fa96d9e98a3de89cf6ebe7a5

- identity pool role mapping
- identity pool
- add role names
- merge unauthorized/authorized role code
- borrow role creation code from action
- include identity pool output value
- don't think users stuff is being created
- dump output to tmp
- create skeleton identity stuff
- separate test class into per- service modules
- test for inheriting from multiple test classes
- remove callbacks support
- remove dash random components
- which in turn means you need to expand demo 
- then really need check that only one of events endpoint topic queue timer can be set for a specific infra
- see invocation type to sync if queue is present as well as endpoint
- remove action async/queue/apigw types
- scripts to insert sqs permissions if queue detected
- script code to bind queue, timer
- add queue, timer to schema options
- add queue, timer to demos
- add queue, timer components
- add queue, timer to list of imports
- look in event sources for bucket, table definitions
- stop empty bucket, table dashboards from being deployed
- events rule target ids can be local
- all script errors to raise exceptions
- add exception if no infra found
- global defaults support
- endpoint should use path as name
- dehungarorise is messing up bucket/table/topic names
- add checks for mis-specified infra yaml
- Config.initialise

```
Traceback (most recent call last):
  File "/Users/jhw/work/expander/expander/pipeline/templater/index.py", line 156, in spawn_template
    template.parameters.update_defaults(self.config.parameters)
  File "/Users/jhw/work/expander/env/lib/python3.8/site-packages/pareto2/config/__init__.py", line 53, in parameters
    params.update(self[attr].parameters)
  File "/Users/jhw/work/expander/env/lib/python3.8/site-packages/pareto2/config/parameters.py", line 8, in parameters
    return {hungarorise(k):v
  File "/Users/jhw/work/expander/env/lib/python3.8/site-packages/pareto2/config/parameters.py", line 8, in <dictcomp>
    return {hungarorise(k):v
NameError: name 'hungarorise' is not defined
```

- convert demo to use hello/world
- load_files to be able to switch directory
- add ext to demo
- pass ext files to expand()
- expand to initialise scripts
- democratise expand so it takes a list of (path, text) pairs
- render callbacks to config
- aggregate callbacks
- add callbacks to schema with type and body
- type is an enum with oncreate value only
- body is an object
- render secret components > convert value to values
- attach indexes to table
- validate GET+params or POST+schema
- index requires table attribute
- add secret to infra
- add index to infra
- validate permission format
- abstract endpoint attachment
- separate action name and action path
- clean up component main blocks
- create table with empty indexes
- populate action env variables
- remove layers and environments
- action invocation types
- initialise actions after apis
- attach endpoints to apis 
- action size and timeout 
- add userpool ref to private api 
- init userpools if private api
- helpers to create apis
- add APIs if public, private 
- dump apis
- scripts method to filter APIs 
- nested event source type
- add demo events, endpoint, layers, permissions
- add method and API to endpoint schema as required fields, method as enum
- add endpoint parameters and schema fields
- add source, topic, pattern fields to event schema 
- remove extra fields option from schema root 
- define action before appending
- if events, layers, permissions exist in infra, add them to actions 
- add topics as per buckets and tables 
- infra schema validation
- parameter defaults
- streaming table
- scripts class
- aggregate buckets, tables across scripts
- add buckets, tables config
- filter environment variables
- add bucketname, tablename os.environ
- script.partition
- add action definition for each index file
- expand to walk through files based on root argument
- new script class to parse infra from code
- pass root to script
- replace file loading with simple inline config
- add basic demo handler in package
- rename DSL as config
- separate config module into per class modules 
- where is the action env variable inference code ?
- remove existing expansions 
- review and document existing expansions - layers, permissions, bindings/type inferences, one more 
- remove all validation code 
- branch 0-4
- populate layer versions should use self.env and shouldnt need env passing to it
- layer population should be part of expansion routine
  - layer population should take entire env struct
- remove cross_validate_layers
- Config.load_file should really just be Config.load
- git push origin :callbacks
- remove randomisation in components, except maybe for dashboard
- remove local components support
- remove timer 
- migration script to add callbacks
- callbacks validation skeleton
- validate callbacks action
- add callbacks class to config (type, action, body)
- liberate bindings class in dsl 
- dev/migrate-0-3-17.py
- init_file to call new expand() method prior to return
- expand to create map of endpoint, topic, timer bindings
- populate invocation type depending on bindings map
- remove dsl invocation checks
- undo env arn support
- add S3, ddb dashboards
- dash to add dashboard name (type, random slug)
- migration script to lookup endpoints and change queue invocation types to apigw
- add DSL support for apigw invocation type
- add action component support for apigw invocation type
- rename sync refs in action component as queue
- refactor sync refs in dsl validation as queue
- migration script to refactor sync type as queue type
- migrator to remove async
- allow invocation check to assume async functions by default
- action decorator to insert async
- migrator to blank table streaming
- timer function size, timeout
- apply function defaults to inline functions
- refactor demo.yaml
- dsl to validate event sources
- refactor dash main block
- convert "short" to "default"
- add default size/timeout parameters (small, short)
- add arn support to action env vars
- remove paretodemo
- add env vars to demo.yaml
- check whether action env vars takes list or keys
- check what the api auth-type parameter is doing in __main__
- ensure topic/pattern/source are optional params
- add event topic attr which pattern matches against detail-type 
- remove template validation from component blocks
- check demo has both bucket and table validations
- test event source changes
- replace components __main__ blocks with single version based in template.py
- extend demo
- roll out action __main__ changes to other components
- add explicit event source attr
- rename event source attrs as type (table, bucket) and name
- component main blocks should call template.parameters.validate, template.validate_root
- rename template.validate_root
- create migration script
- remove event action source 
- check/remove parameter mandatory key validation stuff
- replace with completeness check, but with optional ignore arg

- repeat for topics, buckets
- check layer keys against layer values
- stop lambda retries
- rename packages as layers
- renamed defaults as parameters
- merge layers into parameters
- remove any other boto- client related code
- refactor component main block template dumping stuff
- remove template s3 dump code
- action permissions is fucked up if you send wildcard permissions
- fix Config.initialise() refs

